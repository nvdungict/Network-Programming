#pragma once

#include <vector>
#include <string>
#include <map>
#include <mutex> // THÊM MỚI: Cần cho thread-safe
#include <nlohmann/json.hpp>

using json = nlohmann::json;

// Struct đơn giản để chứa câu hỏi
struct Question {
    std::string id;
    std::string text;
    std::map<std::string, std::string> options;
    std::string correct_answer;
};

class Server {
public:
    Server(int port);
    ~Server();
    bool start();
    void run(); // Vòng lặp chính để accept client

private:
    /**
     * @brief Logic xử lý 1 client (Bao gồm Đăng nhập VÀ Chơi game).
     */
    void handleClient(int client_socket);

    // --- PHẦN XỬ LÝ CÂU HỎI (CŨ) ---
    void loadQuestions(const std::string& filename);
    Question getRandomQuestion();

    // --- PHẦN XỬ LÝ USER (THÊM MỚI) ---
    /**
     * @brief Tải file data/users.json vào bộ nhớ.
     */
    void loadUsers(const std::string& filename);

    /**
     * @brief Lưu lại vector loaded_users vào file (khi khóa tài khoản).
     * @return true nếu lưu thành công.
     */
    bool saveUsers(const std::string& filename);

    /**
     * @brief Logic chính: Kiểm tra thông tin đăng nhập, xử lý 3 lần sai.
     * @param attempts Biến (của thread) đếm số lần sai.
     * @param fail_reason Thông báo lý do thất bại.
     * @return true nếu đăng nhập thành công.
     */

    bool checkLogin(const std::string& user, const std::string& pass, int& attempts, std::string& fail_reason, int& user_db_index);

    // --- BIẾN THÀNH VIÊN ---
    int server_fd;
    int port;
    std::vector<Question> questions;

    // --- BIẾN THÀNH VIÊN MỚI ---
    std::vector<json> loaded_users; // Lưu CSDL user (tải từ users.json)
    std::mutex g_users_mutex;         // Khóa để bảo vệ file/vector user
};
